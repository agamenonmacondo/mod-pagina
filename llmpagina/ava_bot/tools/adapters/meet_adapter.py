import logging
import os
import sys
import json
import uuid
from datetime import datetime, timedelta
from pathlib import Path
from typing import Dict, Any, List, Optional

logger = logging.getLogger(__name__)

class MeetAdapter:
    """Adaptador para Google Meet - Enlaces Reales de Google Meet"""
    
    name = "meet"
    description = "Create Google Meet meetings with real links"
    
    def __init__(self):
        """Inicializaci√≥n con enlaces reales de Google Meet"""
        try:
            self.description = "Ava Bot meet tool - Create Google Meet meetings with real links"
            logger.info("üîç Inicializando MeetAdapter...")
            
            # ‚úÖ RUTA CORREGIDA PARA ENCONTRAR TOKEN.JSON
            current_dir = Path(__file__).parent           # .../tools/adapters/
            tools_dir = current_dir.parent                # .../tools/
            ava_bot_dir = tools_dir.parent                # .../ava_bot/
            token_path = ava_bot_dir / 'token.json'       # .../ava_bot/token.json
            
            logger.info(f"üîç Buscando token en: {token_path}")
            
            # ‚úÖ CARGAR MEET MANAGER REAL
            self.meet_manager = None
            self.has_credentials = False
            
            if token_path.exists():
                logger.info(f"‚úÖ Token encontrado: {token_path}")
                self.token_path = str(token_path)
                
                # ‚úÖ CREAR MEET MANAGER SIMPLIFICADO SIN DEPENDENCIAS
                try:
                    self._initialize_meet_manager(str(token_path))
                    logger.info("‚úÖ MeetManager REAL inicializado - enlaces Meet disponibles")
                    print("‚úÖ MeetManager cargado - enlaces Google Meet reales disponibles")
                    
                except Exception as e:
                    logger.error(f"‚ùå Error inicializando MeetManager: {e}")
                    print(f"‚ö†Ô∏è MeetManager no disponible: {e}")
                    self.has_credentials = False
                    self.meet_manager = None
            else:
                logger.info(f"‚ÑπÔ∏è Token no encontrado en {token_path}, usando modo b√°sico")
                print(f"‚ö†Ô∏è Token no encontrado - modo b√°sico")
                self.has_credentials = False
                self.token_path = None
                self.meet_manager = None
            
            logger.info("‚úÖ MeetAdapter inicializado correctamente")
            
        except Exception as e:
            logger.error(f"‚ùå Error inicializando MeetAdapter: {e}")
            print(f"‚ùå Error en MeetAdapter: {e}")
            # NO fallar - continuar en modo b√°sico
            self.has_credentials = False
            self.token_path = None
            self.meet_manager = None
            self.description = "Ava Bot meet tool - Basic mode"
    
    def _initialize_meet_manager(self, token_path: str):
        """Inicializa el manager de Google Meet sin dependencias externas"""
        try:
            from google.oauth2.credentials import Credentials
            from googleapiclient.discovery import build
            
            class SimpleMeetManager:
                """MeetManager simplificado para crear enlaces reales de Google Meet"""
                
                def __init__(self, token_path: str):
                    """Inicializar con credenciales de Google"""
                    # Cargar credenciales desde token.json
                    with open(token_path, 'r') as f:
                        token_data = json.load(f)
                    
                    self.creds = Credentials(
                        token=token_data.get('token'),
                        refresh_token=token_data.get('refresh_token'),
                        token_uri=token_data.get('token_uri'),
                        client_id=token_data.get('client_id'),
                        client_secret=token_data.get('client_secret'),
                        scopes=token_data.get('scopes', ['https://www.googleapis.com/auth/calendar'])
                    )
                    
                    # Verificar que las credenciales est√©n v√°lidas
                    if self.creds.expired and self.creds.refresh_token:
                        from google.auth.transport.requests import Request
                        self.creds.refresh(Request())
                    
                    self.service = build('calendar', 'v3', credentials=self.creds)
                
                def create_meet_event(self, summary: str, start_time: str, duration_hours: float = 1.0, 
                                    attendees: List[str] = None, description: str = "", 
                                    timezone: str = 'America/Bogota') -> Dict[str, Any]:
                    """Crear evento con Google Meet REAL"""
                    try:
                        # ‚úÖ PROCESAR FECHA Y HORA
                        if isinstance(start_time, str):
                            if 'T' in start_time:
                                start_dt = datetime.fromisoformat(start_time.replace('Z', '+00:00'))
                            else:
                                start_dt = datetime.fromisoformat(f"{start_time}T00:00:00")
                        else:
                            start_dt = start_time
                        
                        end_dt = start_dt + timedelta(hours=duration_hours)
                        
                        # ‚úÖ PROCESAR ASISTENTES
                        event_attendees = []
                        if attendees:
                            for email in attendees:
                                if email and '@' in email:
                                    event_attendees.append({'email': email.strip()})
                        
                        # ‚úÖ CREAR EVENTO CON GOOGLE MEET
                        event_body = {
                            'summary': summary,
                            'description': description or f"Reuni√≥n creada por AVA\n\nT√≠tulo: {summary}",
                            'start': {
                                'dateTime': start_dt.isoformat(),
                                'timeZone': timezone,
                            },
                            'end': {
                                'dateTime': end_dt.isoformat(),
                                'timeZone': timezone,
                            },
                            'attendees': event_attendees,
                            'conferenceData': {
                                'createRequest': {
                                    'requestId': f'ava-meet-{uuid.uuid4()}',
                                    'conferenceSolutionKey': {
                                        'type': 'hangoutsMeet'
                                    }
                                }
                            },
                            'reminders': {
                                'useDefault': False,
                                'overrides': [
                                    {'method': 'email', 'minutes': 24 * 60},  # 1 d√≠a antes
                                    {'method': 'popup', 'minutes': 10},       # 10 minutos antes
                                ],
                            }
                        }
                        
                        print(f"üîÑ Creando evento con Google Meet: {summary}")
                        print(f"üìÖ Fecha: {start_dt.strftime('%Y-%m-%d %H:%M:%S')}")
                        print(f"üë• Asistentes: {[att['email'] for att in event_attendees]}")
                        
                        # ‚úÖ CREAR EVENTO EN GOOGLE CALENDAR CON MEET
                        created_event = self.service.events().insert(
                            calendarId='primary',
                            body=event_body,
                            conferenceDataVersion=1  # CR√çTICO para Google Meet
                        ).execute()
                        
                        # ‚úÖ EXTRAER ENLACES REALES
                        meet_link = None
                        join_url = None
                        
                        # Buscar enlace de Google Meet en conferenceData
                        if created_event.get('conferenceData'):
                            conf_data = created_event['conferenceData']
                            
                            # M√©todo 1: entryPoints con tipo 'video'
                            if conf_data.get('entryPoints'):
                                for entry_point in conf_data['entryPoints']:
                                    if entry_point.get('entryPointType') == 'video':
                                        meet_link = entry_point.get('uri')
                                        break
                            
                            # M√©todo 2: conferenceId para construir URL
                            if not meet_link and conf_data.get('conferenceId'):
                                conf_id = conf_data['conferenceId']
                                meet_link = f"https://meet.google.com/{conf_id}"
                        
                        # ‚úÖ VERIFICAR QUE EL ENLACE SEA V√ÅLIDO
                        if meet_link and 'meet.google.com' in meet_link:
                            print(f"‚úÖ Google Meet creado exitosamente!")
                            print(f"üîó Enlace Meet REAL: {meet_link}")
                        else:
                            print(f"‚ö†Ô∏è Advertencia: Enlace de Meet no generado")
                        
                        # ‚úÖ DATOS DE DEBUG
                        event_link = created_event.get('htmlLink', 'No disponible')
                        event_id = created_event.get('id', 'No disponible')
                        
                        print(f"üìÖ Evento calendario: {event_link}")
                        print(f"üÜî ID evento: {event_id}")
                        
                        return {
                            'meet_link': meet_link,
                            'event_link': event_link,
                            'event_id': event_id,
                            'conference_data': created_event.get('conferenceData'),
                            'status': 'success',
                            'error': None
                        }
                        
                    except Exception as e:
                        error_msg = f"Error creando reuni√≥n Google Meet: {str(e)}"
                        logger.error(error_msg)
                        print(f"‚ùå {error_msg}")
                        
                        return {
                            'meet_link': None,
                            'event_link': None,
                            'event_id': None,
                            'status': 'failed',
                            'error': error_msg
                        }
            
            # Instanciar el manager
            self.meet_manager = SimpleMeetManager(token_path)
            self.has_credentials = True
            
        except ImportError as e:
            logger.error(f"Google API libraries not installed: {e}")
            raise Exception("Google API libraries required: google-auth google-auth-oauthlib google-api-python-client")
        except Exception as e:
            logger.error(f"Error inicializando SimpleMeetManager: {e}")
            raise
    
    @property
    def schema(self) -> Dict[str, Any]:
        """Schema para Google Meet adapter"""
        return {
            "type": "object",
            "properties": {
                "action": {
                    "type": "string",
                    "enum": ["create"],
                    "description": "Acci√≥n a realizar (solo create disponible)"
                },
                "title": {
                    "type": "string",
                    "description": "T√≠tulo de la reuni√≥n",
                    "minLength": 1,
                    "maxLength": 200
                },
                "summary": {
                    "type": "string",
                    "description": "T√≠tulo de la reuni√≥n (alternativo a title)"
                },
                "date": {
                    "type": "string",
                    "description": "Fecha y hora de inicio - formato: YYYY-MM-DDTHH:MM:SS"
                },
                "start_time": {
                    "type": "string",
                    "description": "Hora de inicio - formato: YYYY-MM-DDTHH:MM:SS"
                },
                "duration": {
                    "type": "number",
                    "description": "Duraci√≥n en horas",
                    "default": 1.0,
                    "minimum": 0.25,
                    "maximum": 8.0
                },
                "attendees": {
                    "type": "string",
                    "description": "Emails de asistentes separados por comas"
                },
                "description": {
                    "type": "string",
                    "description": "Descripci√≥n de la reuni√≥n"
                }
            },
            "required": [],
            "additionalProperties": False
        }
    
    def execute(self, arguments: Dict[str, Any]) -> Dict[str, Any]:
        """Ejecutar creaci√≥n de reuni√≥n Google Meet con enlaces reales"""
        try:
            # ‚úÖ SELF-TEST AL EJECUTAR
            if not hasattr(self, '_self_tested'):
                self._run_self_test()
                self._self_tested = True
            
            logger.info(f"üéØ MeetAdapter.execute llamado con: {arguments}")
            
            # ‚úÖ EXTRAER ARGUMENTOS - m√∫ltiples formatos
            meeting_title = (arguments.get('title') or 
                           arguments.get('summary') or 
                           arguments.get('event_name') or 
                           arguments.get('meeting_name') or 
                           'Reuni√≥n Google Meet con AVA')
            
            meeting_date = (arguments.get('date') or 
                          arguments.get('start_time') or 
                          arguments.get('time'))
            
            meeting_duration = arguments.get('duration', 1.0)
            meeting_attendees = arguments.get('attendees', '')
            meeting_description = arguments.get('description', '')
            
            # ‚úÖ PROCESAR ASISTENTES
            if isinstance(meeting_attendees, list):
                attendees_list = meeting_attendees
            elif isinstance(meeting_attendees, str) and meeting_attendees:
                attendees_list = [email.strip() for email in meeting_attendees.split(',') if email.strip()]
            else:
                attendees_list = []
            
            # ‚úÖ PROCESAR DURACI√ìN
            if isinstance(meeting_duration, str):
                try:
                    meeting_duration = float(''.join(filter(str.isdigit, meeting_duration))) or 1.0
                except:
                    meeting_duration = 1.0
            
            # ‚úÖ GENERAR FECHA SI NO EXISTE
            if not meeting_date:
                # Usar ma√±ana a las 3 PM como default
                tomorrow = datetime.now() + timedelta(days=1)
                meeting_date = tomorrow.replace(hour=15, minute=0, second=0, microsecond=0).isoformat()
                print(f"üìÖ Fecha generada autom√°ticamente: {meeting_date}")
            
            # ‚úÖ VALIDAR QUE LA FECHA SEA FUTURA
            try:
                if 'T' not in meeting_date:
                    meeting_date = f"{meeting_date}T15:00:00"
                
                start_time = datetime.fromisoformat(meeting_date.replace('Z', '+00:00'))
                now = datetime.now()
                
                if start_time < now:
                    print(f"‚ö†Ô∏è FECHA PASADA DETECTADA: {start_time} < {now}")
                    start_time = now + timedelta(days=1)
                    start_time = start_time.replace(hour=15, minute=0, second=0, microsecond=0)
                    meeting_date = start_time.isoformat()
                    print(f"‚úÖ FECHA CORREGIDA A: {start_time}")
                
            except Exception as e:
                print(f"‚ùå Error procesando fecha: {e}")
                tomorrow = datetime.now() + timedelta(days=1)
                meeting_date = tomorrow.replace(hour=15, minute=0, second=0, microsecond=0).isoformat()
            
            # ‚úÖ CREAR REUNI√ìN REAL CON GOOGLE MEET
            if self.has_credentials and self.meet_manager:
                # MODO REAL - CREAR REUNI√ìN EN GOOGLE MEET
                logger.info(f"üìû Creando reuni√≥n REAL con Google Meet: {meeting_title}")
                
                try:
                    result = self.meet_manager.create_meet_event(
                        summary=meeting_title,
                        start_time=meeting_date,
                        duration_hours=meeting_duration,
                        attendees=attendees_list,
                        description=meeting_description
                    )
                    
                    if result and result.get('meet_link') and not result.get('error'):
                        # ‚úÖ REUNI√ìN CREADA EXITOSAMENTE
                        meet_link = result['meet_link']
                        event_link = result.get('event_link', 'No disponible')
                        event_id = result.get('event_id', 'No disponible')
                        
                        # ‚úÖ FORMATEAR FECHAS
                        start_formatted = datetime.fromisoformat(meeting_date.replace('Z', '+00:00')).strftime('%Y-%m-%d %H:%M:%S')
                        
                        response_text = f"""üìû **¬°REUNI√ìN GOOGLE MEET CREADA EXITOSAMENTE!**

üéØ **T√≠tulo:** {meeting_title}
üìÖ **Inicio:** {start_formatted}
‚è±Ô∏è **Duraci√≥n:** {meeting_duration} horas
üë• **Asistentes:** {', '.join(attendees_list) if attendees_list else 'Ninguno'}

üîó **ENLACE GOOGLE MEET (REAL):** {meet_link}
üìÖ **ENLACE CALENDAR (REAL):** {event_link}
üÜî **ID del evento:** {event_id}

‚úÖ **Estado:** Reuni√≥n creada con √©xito
üìß **Invitaciones:** {('Enviadas a ' + ', '.join(attendees_list)) if attendees_list else 'No hay asistentes'}
üîî **Recordatorios:** Configurados autom√°ticamente

üí° **Para unirse:** Haz clic en el enlace de Google Meet o b√∫scalo en tu calendario"""
                        
                        print(f"‚úÖ REUNI√ìN GOOGLE MEET CREADA CON √âXITO")
                        print(f"üîó Link Meet REAL: {meet_link}")
                        
                        return {
                            "content": [{
                                "type": "text",
                                "text": response_text
                            }]
                        }
                    else:
                        # Error en la creaci√≥n
                        error_msg = result.get('error', 'Error desconocido') if result else 'No se recibi√≥ respuesta'
                        response_text = f"""‚ùå **Error creando reuni√≥n Google Meet**

üîç **Detalles del error:** {error_msg}
üìû **Posibles causas:**
‚Ä¢ Token expirado o sin permisos suficientes
‚Ä¢ Google Calendar API no configurada correctamente
‚Ä¢ Problemas de conectividad

üí° **Soluci√≥n:** Regenera las credenciales con permisos completos de Calendar API"""
                        
                        print(f"‚ùå ERROR CREANDO REUNI√ìN: {error_msg}")
                        
                except Exception as e:
                    logger.error(f"Error creando reuni√≥n real: {e}")
                    response_text = f"""‚ùå **Error de conexi√≥n con Google Meet**

üîç **Error t√©cnico:** {str(e)}
üìû **Posibles causas:**
‚Ä¢ Credenciales inv√°lidas o expiradas
‚Ä¢ Google Calendar API no habilitada
‚Ä¢ Permisos insuficientes para Google Meet

üí° **Soluci√≥n:** Verifica la configuraci√≥n de Google Calendar API"""
                    
                    print(f"‚ùå EXCEPCI√ìN CREANDO REUNI√ìN: {e}")
            else:
                # MODO B√ÅSICO INFORMATIVO
                start_formatted = datetime.fromisoformat(meeting_date.replace('Z', '+00:00')).strftime('%Y-%m-%d %H:%M:%S')
                
                response_text = f"""üìû **Solicitud de reuni√≥n Google Meet recibida**

üéØ **T√≠tulo:** {meeting_title}
üìÖ **Inicio:** {start_formatted}
‚è±Ô∏è **Duraci√≥n:** {meeting_duration} horas
üë• **Asistentes:** {', '.join(attendees_list) if attendees_list else 'Ninguno'}

‚úÖ **Solicitud procesada correctamente**

üîß **Para crear reuniones REALES de Google Meet:**
‚Ä¢ Configura Google Calendar API con permisos completos
‚Ä¢ Autoriza acceso a Google Calendar y Google Meet
‚Ä¢ Reinicia el sistema MCP

üìß **Mientras tanto:** Te ayudo a coordinar la reuni√≥n por email"""
            
            return {
                "content": [{
                    "type": "text",
                    "text": response_text
                }]
            }
            
        except Exception as e:
            logger.error(f"Error en MeetAdapter: {e}")
            return {
                "content": [{
                    "type": "text",
                    "text": f"‚ùå Error procesando reuni√≥n Google Meet: {str(e)}"
                }]
            }
    
    def _run_self_test(self):
        """Auto-test del adapter para verificar funcionamiento"""
        print(f"\nüß™ MEET ADAPTER SELF-TEST")
        print(f"=" * 40)
        print(f"üìÅ Token path: {getattr(self, 'token_path', 'N/A')}")
        print(f"üîë Has credentials: {self.has_credentials}")
        print(f"üîß Meet manager: {'‚úÖ Activo' if self.meet_manager else '‚ùå No disponible'}")
        
        if self.meet_manager:
            try:
                print(f"‚úÖ Test de conexi√≥n: EXITOSO")
                print(f"üìä Puede crear reuniones reales de Google Meet")
                print(f"üîó Genera enlaces: https://meet.google.com/...")
            except Exception as e:
                print(f"‚ö†Ô∏è Test de conexi√≥n: ERROR - {e}")
        else:
            print(f"‚ÑπÔ∏è Modo b√°sico - sin conexi√≥n real")
        
        print(f"=" * 40)
    
    def process(self, arguments: Dict[str, Any]) -> str:
        """Alias para execute (compatibilidad)"""
        result = self.execute(arguments)
        if isinstance(result, dict) and "content" in result:
            return result["content"][0]["text"]
        return str(result)

# ‚úÖ SELF-TEST AL IMPORTAR
if __name__ == "__main__":
    print("üß™ PROBANDO MEET ADAPTER...")
    adapter = MeetAdapter()
    
    # Test b√°sico con asistente real
    tomorrow = datetime.now() + timedelta(days=1)
    test_date = tomorrow.replace(hour=16, minute=0, second=0, microsecond=0).isoformat()
    
    test_args = {
        "action": "create",
        "title": "üß™ Test Google Meet - ENLACES REALES",
        "date": test_date,
        "duration": 1,
        "attendees": "agamenonmacondo@gmail.com",
        "description": "Reuni√≥n de prueba para validar enlaces reales de Google Meet creados por AVA"
    }
    
    print(f"\nüìã ARGUMENTOS DE PRUEBA:")
    print(f"   üìÖ Fecha: {test_date}")
    print(f"   üë§ Asistente: agamenonmacondo@gmail.com")
    print(f"   ‚è±Ô∏è Duraci√≥n: 1 hora")
    
    result = adapter.execute(test_args)
    print(f"\nüìã RESULTADO:")
    print(result["content"][0]["text"])
    
    print(f"\nüîö Test completado")